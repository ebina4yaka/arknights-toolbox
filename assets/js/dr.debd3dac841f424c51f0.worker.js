(function(t){var e={};function n(r){if(e[r])return e[r].exports;var s=e[r]={i:r,l:!1,exports:{}};return t[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)n.d(r,s,function(e){return t[e]}.bind(null,s));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="https://cdn.jsdelivr.net/gh/arkntools/arknights-toolbox@gh-pages/",n(n.s="48d1")})({"48d1":function(t,e,n){"use strict";n.r(e),n.d(e,"DeportRecognizer",(function(){return pt})),n.d(e,"MAX_SHOW_DIFF",(function(){return Y})),n.d(e,"MAX_TRUST_DIFF",(function(){return tt})),n.d(e,"isTrustedResult",(function(){return et})),n.d(e,"toSimpleTrustedResult",(function(){return dt}));const r=Symbol("Comlink.proxy"),s=Symbol("Comlink.endpoint"),i=Symbol("Comlink.releaseProxy"),o=Symbol("Comlink.thrown"),a=t=>"object"===typeof t&&null!==t||"function"===typeof t,l={canHandle:t=>a(t)&&t[r],serialize(t){const{port1:e,port2:n}=new MessageChannel;return p(t,e),[n,[n]]},deserialize(t){return t.start(),h(t)}},c={canHandle:t=>a(t)&&o in t,serialize({value:t}){let e;return e=t instanceof Error?{isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:{isError:!1,value:t},[e,[]]},deserialize(t){if(t.isError)throw Object.assign(new Error(t.value.message),t.value);throw t.value}},u=new Map([["proxy",l],["throw",c]]);function p(t,e=self){e.addEventListener("message",(function n(r){if(!r||!r.data)return;const{id:s,type:i,path:a}=Object.assign({path:[]},r.data),l=(r.data.argumentList||[]).map(j);let c;try{const e=a.slice(0,-1).reduce((t,e)=>t[e],t),n=a.reduce((t,e)=>t[e],t);switch(i){case 0:c=n;break;case 1:e[a.slice(-1)[0]]=j(r.data.value),c=!0;break;case 2:c=n.apply(e,l);break;case 3:{const t=new n(...l);c=M(t)}break;case 4:{const{port1:e,port2:n}=new MessageChannel;p(t,n),c=w(e,[e])}break;case 5:c=void 0;break}}catch(u){c={value:u,[o]:0}}Promise.resolve(c).catch(t=>({value:t,[o]:0})).then(t=>{const[r,o]=x(t);e.postMessage(Object.assign(Object.assign({},r),{id:s}),o),5===i&&(e.removeEventListener("message",n),d(e))})})),e.start&&e.start()}function m(t){return"MessagePort"===t.constructor.name}function d(t){m(t)&&t.close()}function h(t,e){return g(t,[],e)}function f(t){if(t)throw new Error("Proxy has been released and is not useable")}function g(t,e=[],n=function(){}){let r=!1;const o=new Proxy(n,{get(n,s){if(f(r),s===i)return()=>E(t,{type:5,path:e.map(t=>t.toString())}).then(()=>{d(t),r=!0});if("then"===s){if(0===e.length)return{then:()=>o};const n=E(t,{type:0,path:e.map(t=>t.toString())}).then(j);return n.then.bind(n)}return g(t,[...e,s])},set(n,s,i){f(r);const[o,a]=x(i);return E(t,{type:1,path:[...e,s].map(t=>t.toString()),value:o},a).then(j)},apply(n,i,o){f(r);const a=e[e.length-1];if(a===s)return E(t,{type:4}).then(j);if("bind"===a)return g(t,e.slice(0,-1));const[l,c]=v(o);return E(t,{type:2,path:e.map(t=>t.toString()),argumentList:l},c).then(j)},construct(n,s){f(r);const[i,o]=v(s);return E(t,{type:3,path:e.map(t=>t.toString()),argumentList:i},o).then(j)}});return o}function y(t){return Array.prototype.concat.apply([],t)}function v(t){const e=t.map(x);return[e.map(t=>t[0]),y(e.map(t=>t[1]))]}const b=new WeakMap;function w(t,e){return b.set(t,e),t}function M(t){return Object.assign(t,{[r]:!0})}function x(t){for(const[e,n]of u)if(n.canHandle(t)){const[r,s]=n.serialize(t);return[{type:3,name:e,value:r},s]}return[{type:0,value:t},b.get(t)||[]]}function j(t){switch(t.type){case 3:return u.get(t.name).deserialize(t.value);case 0:return t.value}}function E(t,e,n){return new Promise(r=>{const s=A();t.addEventListener("message",(function e(n){n.data&&n.data.id&&n.data.id===s&&(t.removeEventListener("message",e),r(n.data))})),t.start&&t.start(),t.postMessage(Object.assign({id:s},e),n)})}function A(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}self.importScripts("https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js","https://cdn.jsdelivr.net/npm/simple-statistics@7.7.0/dist/simple-statistics.min.js","https://cdn.jsdelivr.net/npm/jszip@3.7.1/dist/jszip.min.js","https://cdn.jsdelivr.net/npm/@arkntools/scripts@1.0.2/dist/ocrad.js","https://cdn.jsdelivr.net/npm/@arkntools/scripts@1.0.2/dist/jimp.js"),Jimp.prototype.toBase64=function(){return this.getBase64Async(Jimp.AUTO)};const S=({start:t,length:e})=>t+e,I=(t,{start:e,length:n})=>e<=t&&t<e+n,P=(t,e)=>_.findIndex(e,e=>I(t,e)),O=t=>_.transform(t,(t,e,n)=>{if(t.length){if(e){const e=_.last(t);n===S(e)?e.length++:t.push({start:n,length:1})}}else e&&t.push({start:n,length:1})},[]),R=(t,e)=>{const n=_.sortBy(O(t),"length").reverse();if(e){const t=.9*e,r=1.1*e;return _.sortBy(n.filter(({length:e})=>t<e&&e<r),"start")}const r=.8*n[0].length;return _.sortBy(n.filter(({length:t})=>t>r),"start")},k=(t,e=1)=>_.remove(t,({length:t})=>t<=e),J=960,T=540,z=1.15,B=60,C=.28,W=[[1,1,1],[1,-9,1],[1,1,1]],L=(t,e=!1)=>{const n=t.clone(),r=(()=>{const t=n.getWidth(),e=n.getHeight();if(t>=e&&t>J)n.resize(J,Jimp.AUTO);else{if(!(e>t&&e>T))return 1;n.resize(Jimp.AUTO,T)}return t/n.getWidth()})(),s=n.clone().greyscale().convolution(W),i=s.getWidth(),o=s.getHeight(),a=new Array(o).fill(0),l=Math.round(.15*i);s.scan(l,0,i-l,o,(function(t,e,n){a[e]+=this.bitmap.data[n]}));const c=R(a.map(t=>t/255>.005*i));let u=_.min(_.map(c,"length"));const p=c.map(()=>new Array(i).fill(0));s.scan(0,0,i,o,(function(t,e,n){const r=P(e,c);-1!==r&&(p[r][t]+=this.bitmap.data[n])}));const m=p.map(t=>R(t.map(t=>t/255>0),u)),d=_.map(_.flatten(m).filter(({start:t,length:e})=>0!==t&&t+e!==i&&e<u&&1-e/u<.05),"length");d.length&&(u=_.min(d));const h=u*(1+C),f=_.flatten(m).map(({start:t,length:e})=>t+e/2),g=_.min(f),y=Math.ceil(g/h),v=f.map(t=>[y+Math.round((t-g)/h),t]),b=c.map(({start:t,length:e},n)=>{const r=e-u,s=t+(e+r)/2;return[n,s]}),w=ss.linearRegressionLine(ss.linearRegression(v)),M=ss.linearRegressionLine(ss.linearRegression(b)),x=Math.round(u*r),j=Math.floor((i+u*(1+C))/h),E=c.length,A=_.range(j).map(t=>{const e=w(t),n=Math.round((e-u/2)*r),s=(e-u*z/2)/i,o=1-(e+u*z/2)/i;return{pos:{x:n},view:{left:s,right:o}}}).filter(({pos:{x:e}})=>e>=0&&e+x<=t.getWidth()),S=_.range(E).map(t=>{const e=M(t),n=Math.round((e-u/2)*r),s=(e-u*z/2)/o,i=1-(e+u*z/2)/o;return{pos:{y:n,l:x},view:{top:s,bottom:i}}}),I=_.flatMap(_.uniqBy(_.flatten(A),"pos.x"),t=>_.uniqBy(_.flatten(S),"pos.y").map(e=>_.merge({debug:{scale:B/(r*u)}},t,e))),O=[];if(e){const e=t.clone();I.forEach(({pos:{x:t,y:n}})=>{for(let r=t;r<t+x;r++)e.setPixelColor(4278190335,r,n),e.setPixelColor(4278190335,r,n+x-1);for(let r=n;r<n+x;r++)e.setPixelColor(4278190335,t,r),e.setPixelColor(4278190335,t+x-1,r)}),O.push(e)}if(e){const t=s.clone();c.forEach(({start:e,length:n})=>{for(let r=0;r<i;r++)for(let s=e;s<e+n;s++){const e=t.getPixelIndex(r,s);t.bitmap.data[e]=200}}),O.push(t)}if(e){const t=s.clone();m.forEach((e,n)=>{const r=c[n];e.forEach(({start:e,length:n})=>{for(let s=e;s<e+n;s++)for(let e=r.start;e<r.start+r.length;e++){const n=t.getPixelIndex(s,e);t.bitmap.data[n]=200}})}),O.push(t)}return{debugImgs:O,posisions:I,itemWidth:Math.round(u*r)}},D=60,H=8,U=20,F=10,G=50,Z=22,X=40,q=73,N=(t=>(e=>new Array(t).fill(e))(new Array(t).fill(1/(t*t))))(3),$=(t,e)=>{const n=t.getWidth(),r=[];for(let s=0;s<n;s++)r.push(e(t,s));return O(r)},K=(t,e)=>{const n=t.getHeight();for(let r=0;r<n;r++){const{r:n}=Jimp.intToRGBA(t.getPixelColor(e,r));if(n<128)return!0}return!1},Q=({splitedImgs:t,itemWidth:e,simResults:n,IMG_SL:r})=>{const s=e/r,i=Math.round(X*s),o=Math.round(q*s),a=Math.round(G*s),l=Math.round(Z*s);return t.map((t,e)=>{var r,s,c;if(!n[e])return null;const u=t.clone().crop(i,o,a,l).resize(Jimp.AUTO,D,Jimp.RESIZE_BEZIER).invert().threshold({max:104}),p=$(u,K);k(p,H),0===(null===(r=p[0])||void 0===r?void 0:r.start)&&p.splice(0,1),_.remove(p,({start:t,length:e},n)=>{const r=p[n+1];if(r&&r.start-(t+e)>U)return!0;for(let s=t;s<t+e;s++){const{r:t}=Jimp.intToRGBA(u.getPixelColor(s,0)),{r:e}=Jimp.intToRGBA(u.getPixelColor(s,D-1));if(t<128||e<128)return!0}return!1});const m=Math.max(Math.floor(null!==(s=null===(c=p[0])||void 0===c?void 0:c.start)&&void 0!==s?s:0),0),d=_.last(p),h=Math.min(Math.ceil(d?S(d):u.getWidth()),u.getWidth());(m>0||h<u.getWidth())&&u.crop(m,0,h-m,u.getHeight());const f=new Jimp(u.getWidth()+2*F,u.getHeight(),"white");return f.composite(u,F,0).convolution(N).invert().threshold({max:2}).invert(),f})},V=t=>Promise.all(t.map(async t=>{if(!t)return null;const e=new ImageData(new Uint8ClampedArray(t.bitmap.data),t.bitmap.width,t.bitmap.height),n=OCRAD(e,{numeric:!0}).trim(),r=parseInt(n.replace(/[^0-9]/g,""))||1;return{img:await t.getBase64Async(Jimp.AUTO),text:n,value:r,warn:n.replace(/ /g,"")!==String(r)}})),Y=.22,tt={DEFAULT:.2,30021:.15,30041:.12,30042:.12,30043:.12,30044:.12,30062:.15,31024:.22},et=t=>{if(!t)return!1;const{diff:e,name:n}=t.sim||t,r=n in tt?tt[n]:tt.DEFAULT;return e<r},nt=(t,e)=>{if(!e.length)return null;const n=_.sortBy(e.map(([e,n])=>[e,Jimp.diff(t,n,.2).percent]),1),[r,s]=n[0];return{name:r,diff:s,diffs:n}},rt=(t,e)=>{if(t.length<=2)return t.map(t=>nt(t,e));const n=Math.floor(t.length/2),r=nt(t[n],e);if(et(r)){const s=e.findIndex(([t])=>t===r.name);return[...rt(t.slice(0,n),e.slice(0,s)),r,...rt(t.slice(n+1),e.slice(s+1))]}{const s=rt(t.slice(0,n),e),i=_.findLast(s,t=>t),o=rt(t.slice(n+1),et(i)?e.slice(e.findIndex(([t])=>t===i.name)+1):e);return[...s,r,...o]}},st=100,it=183,ot=151,at=(it-ot)/2,lt=new Jimp(54,28,"white"),ct=39,ut=70;class pt{constructor(t){this.config=t,this.isDebug=!1}setDebug(t){this.isDebug=t}async loadResource(){if(this.itemImgs)return this.itemImgs;const t=await JSZip.loadAsync(..._.castArray(this.config.pkg)),e=await Promise.all(this.config.order.map(async e=>{try{const n=t.file(e+".png");return n?Jimp.read(await n.async("arraybuffer")):void console.warn(`[depot-recognition] ${e}.png not exist in pkg`)}catch(n){console.error("[depot-recognition]",n)}}));return this.itemImgs=_.zip(this.config.order,e.map(t=>null===t||void 0===t?void 0:t.crop(at,at,ot,ot).resize(st,st,Jimp.RESIZE_BEZIER).composite(lt,ct,ut).circle())).filter(([,t])=>t),this.itemImgs}async recognize(t,e=(()=>{})){const n=[],r=(()=>{let t=0;return()=>e(t++)})();r();const[s,i]=await Promise.all([Jimp.read(t),this.loadResource()]);r();const{posisions:o,itemWidth:a,debugImgs:l}=L(s,this.isDebug);this.isDebug&&n.push(...l);const c=o.map(({pos:{x:t,y:e}})=>s.clone().crop(t,e,a,a)),u=c.map(t=>t.clone().resize(st,st).composite(lt,ct,ut).circle());r();const p=rt(u,i);r();const m=Q({splitedImgs:c,itemWidth:a,simResults:p,IMG_SL:st});r();const d=await V(m);return{data:_.merge(o,p.map(t=>({sim:t})),d.map(t=>({num:t}))),debug:await Promise.all(n.map(t=>t.toBase64()))}}}const mt=t=>{const e={};return t.forEach(([t,n])=>e[t]=n),e},dt=t=>mt(t.filter(et).map(({num:{value:t},sim:{name:e}})=>[e,t]));p(Object.keys(e).reduce((function(t,n){return"__esModule"==n||(t[n]=e[n]),t}),{}))}});